import requests
import re
from datetime import datetime
from difflib import get_close_matches
from logger import get_logger

logger = get_logger(__name__)

OLLAMA_API_URL = "http://localhost:11434/api/generate"
MODEL_NAME = "llama3:latest"

COMMON_WORDS = {
    # === БАЗОВЫЕ СЛОВА ===
    # Животные
    "cat",
    "dog",
    "bird",
    "fish",
    "horse",
    "cow",
    "pig",
    "chicken",
    "mouse",
    "pet",
    # Дом и места
    "house",
    "home",
    "flat",
    "apartment",
    "room",
    "kitchen",
    "bedroom",
    "bathroom",
    "door",
    "window",
    "wall",
    "floor",
    "roof",
    "garden",
    "yard",
    "building",
    "city",
    "town",
    "village",
    "country",
    "street",
    "road",
    "bridge",
    "shop",
    "store",
    # Транспорт
    "car",
    "bus",
    "train",
    "plane",
    "bike",
    "bicycle",
    "ship",
    "boat",
    "metro",
    "subway",
    "taxi",
    "truck",
    "motorcycle",
    "helicopter",
    # Природа
    "tree",
    "flower",
    "plant",
    "grass",
    "leaf",
    "river",
    "lake",
    "sea",
    "ocean",
    "mountain",
    "hill",
    "forest",
    "sky",
    "sun",
    "moon",
    "star",
    "cloud",
    "rain",
    "snow",
    "wind",
    "fire",
    "water",
    "earth",
    "stone",
    "rock",
    "beach",
    "island",
    # === ТУРИЗМ И ПУТЕШЕСТВИЯ ===
    "travel",
    "trip",
    "journey",
    "tour",
    "tourist",
    "vacation",
    "holiday",
    "resort",
    "hotel",
    "hostel",
    "motel",
    "inn",
    "accommodation",
    "reservation",
    "booking",
    "airport",
    "flight",
    "ticket",
    "boarding",
    "gate",
    "departure",
    "arrival",
    "passport",
    "visa",
    "customs",
    "luggage",
    "baggage",
    "suitcase",
    "backpack",
    "guide",
    "map",
    "destination",
    "route",
    "itinerary",
    "excursion",
    "sightseeing",
    "souvenir",
    "attraction",
    "landmark",
    "museum",
    "gallery",
    "monument",
    "cruise",
    "camping",
    "hiking",
    "adventure",
    "explorer",
    # === БИЗНЕС ===
    "business",
    "company",
    "corporation",
    "firm",
    "enterprise",
    "startup",
    "office",
    "manager",
    "director",
    "boss",
    "employee",
    "staff",
    "team",
    "colleague",
    "meeting",
    "conference",
    "presentation",
    "report",
    "project",
    "task",
    "deadline",
    "contract",
    "agreement",
    "deal",
    "partnership",
    "client",
    "customer",
    "supplier",
    "profit",
    "loss",
    "revenue",
    "income",
    "expense",
    "budget",
    "investment",
    "salary",
    "wage",
    "bonus",
    "commission",
    "payment",
    "invoice",
    "receipt",
    "marketing",
    "sales",
    "advertising",
    "promotion",
    "brand",
    "strategy",
    "negotiation",
    "proposal",
    "quotation",
    "tender",
    "outsourcing",
    # === ИНТЕРНЕТ И ТЕХНОЛОГИИ ===
    "internet",
    "online",
    "offline",
    "website",
    "webpage",
    "blog",
    "forum",
    "email",
    "message",
    "chat",
    "video",
    "call",
    "zoom",
    "skype",
    "app",
    "application",
    "software",
    "program",
    "system",
    "platform",
    "download",
    "upload",
    "install",
    "update",
    "upgrade",
    "delete",
    "computer",
    "laptop",
    "tablet",
    "phone",
    "smartphone",
    "mobile",
    "screen",
    "keyboard",
    "mouse",
    "printer",
    "scanner",
    "camera",
    "wifi",
    "bluetooth",
    "network",
    "connection",
    "server",
    "cloud",
    "password",
    "username",
    "account",
    "profile",
    "settings",
    "social",
    "media",
    "facebook",
    "instagram",
    "twitter",
    "youtube",
    "google",
    "search",
    "browser",
    "link",
    "url",
    "click",
    "data",
    "file",
    "folder",
    "document",
    "backup",
    "storage",
    "virus",
    "security",
    "firewall",
    "encryption",
    "privacy",
    "coding",
    "programming",
    "developer",
    "software",
    "hardware",
    "artificial",
    "intelligence",
    "robot",
    "automation",
    "digital",
    # === БЬЮТИ ИНДУСТРИЯ ===
    "beauty",
    "makeup",
    "cosmetics",
    "skincare",
    "haircare",
    "salon",
    "spa",
    "barbershop",
    "hairdresser",
    "stylist",
    "beautician",
    "haircut",
    "hairstyle",
    "hair",
    "coloring",
    "dyeing",
    "bleaching",
    "manicure",
    "pedicure",
    "nails",
    "polish",
    "gel",
    "facial",
    "massage",
    "treatment",
    "therapy",
    "procedure",
    "cream",
    "lotion",
    "serum",
    "mask",
    "cleanser",
    "toner",
    "lipstick",
    "mascara",
    "foundation",
    "powder",
    "blush",
    "eyeshadow",
    "perfume",
    "fragrance",
    "scent",
    "cologne",
    "skin",
    "face",
    "body",
    "hair",
    "nails",
    "lips",
    "eyes",
    "wrinkle",
    "acne",
    "scar",
    "blemish",
    "tan",
    "pale",
    # === МОДА ===
    "fashion",
    "style",
    "trend",
    "look",
    "outfit",
    "wardrobe",
    "clothes",
    "clothing",
    "dress",
    "shirt",
    "blouse",
    "skirt",
    "pants",
    "jeans",
    "jacket",
    "coat",
    "sweater",
    "hoodie",
    "shoes",
    "boots",
    "sneakers",
    "accessories",
    "bag",
    "belt",
    "hat",
    "scarf",
    "gloves",
    "jewelry",
    "brand",
    "designer",
    "boutique",
    "shopping",
    "sale",
    "discount",
    "size",
    "fit",
    "color",
    "pattern",
    "fabric",
    "material",
    "leather",
    # === ЗДОРОВЬЕ И МЕДИЦИНА ===
    "health",
    "medicine",
    "medical",
    "doctor",
    "nurse",
    "patient",
    "hospital",
    "clinic",
    "pharmacy",
    "drugstore",
    "disease",
    "illness",
    "sickness",
    "pain",
    "ache",
    "fever",
    "cold",
    "flu",
    "treatment",
    "therapy",
    "surgery",
    "operation",
    "examination",
    "checkup",
    "prescription",
    "pill",
    "tablet",
    "capsule",
    "injection",
    "vaccine",
    "healthy",
    "sick",
    "ill",
    "tired",
    "weak",
    "strong",
    "fit",
    "symptom",
    "diagnosis",
    "recovery",
    "cure",
    "healing",
    # === СПОРТ И ФИТНЕС ===
    "sport",
    "sports",
    "gym",
    "fitness",
    "workout",
    "exercise",
    "training",
    "coach",
    "trainer",
    "athlete",
    "player",
    "team",
    "match",
    "game",
    "competition",
    "running",
    "jogging",
    "swimming",
    "cycling",
    "yoga",
    "pilates",
    "football",
    "soccer",
    "basketball",
    "tennis",
    "golf",
    "boxing",
    "muscle",
    "strength",
    "cardio",
    "stretching",
    "warm-up",
    "cool-down",
    # === ЕДА И РЕСТОРАНЫ ===
    "food",
    "meal",
    "dish",
    "cuisine",
    "recipe",
    "ingredient",
    "cooking",
    "restaurant",
    "cafe",
    "bar",
    "pub",
    "canteen",
    "cafeteria",
    "menu",
    "order",
    "waiter",
    "waitress",
    "chef",
    "cook",
    "breakfast",
    "lunch",
    "dinner",
    "snack",
    "dessert",
    "appetizer",
    "meat",
    "chicken",
    "beef",
    "pork",
    "fish",
    "seafood",
    "vegetable",
    "fruit",
    "salad",
    "soup",
    "pasta",
    "pizza",
    "burger",
    "bread",
    "rice",
    "potato",
    "egg",
    "cheese",
    "milk",
    "butter",
    "coffee",
    "tea",
    "juice",
    "water",
    "wine",
    "beer",
    "cocktail",
    "delicious",
    "tasty",
    "yummy",
    "spicy",
    "sweet",
    "sour",
    "bitter",
    "salty",
    # === ФИНАНСЫ ===
    "money",
    "cash",
    "credit",
    "debit",
    "card",
    "account",
    "balance",
    "bank",
    "banking",
    "branch",
    "atm",
    "transfer",
    "deposit",
    "withdrawal",
    "loan",
    "mortgage",
    "interest",
    "rate",
    "debt",
    "payment",
    "installment",
    "currency",
    "dollar",
    "euro",
    "pound",
    "exchange",
    "forex",
    "investment",
    "investor",
    "stock",
    "share",
    "portfolio",
    "dividend",
    "insurance",
    "policy",
    "premium",
    "claim",
    "coverage",
    "tax",
    "fee",
    "charge",
    "cost",
    "price",
    "value",
    "worth",
    # === ОБРАЗОВАНИЕ ===
    "education",
    "school",
    "university",
    "college",
    "institute",
    "academy",
    "student",
    "pupil",
    "teacher",
    "professor",
    "lecturer",
    "tutor",
    "class",
    "lesson",
    "course",
    "subject",
    "program",
    "curriculum",
    "exam",
    "test",
    "quiz",
    "homework",
    "assignment",
    "project",
    "grade",
    "mark",
    "score",
    "diploma",
    "degree",
    "certificate",
    "study",
    "learn",
    "teach",
    "practice",
    "training",
    "knowledge",
    # === РАБОТА ===
    "work",
    "job",
    "career",
    "profession",
    "occupation",
    "position",
    "hire",
    "employ",
    "recruit",
    "interview",
    "resume",
    "cv",
    "experience",
    "skill",
    "qualification",
    "expertise",
    "ability",
    "full-time",
    "part-time",
    "freelance",
    "remote",
    "office",
    "shift",
    "schedule",
    "overtime",
    "leave",
    "vacation",
    "sick",
    # === ОБЩИЕ ГЛАГОЛЫ ===
    "be",
    "have",
    "do",
    "make",
    "get",
    "go",
    "come",
    "see",
    "look",
    "take",
    "give",
    "use",
    "find",
    "tell",
    "ask",
    "work",
    "call",
    "try",
    "need",
    "feel",
    "become",
    "leave",
    "put",
    "mean",
    "keep",
    "let",
    "begin",
    "seem",
    "help",
    "talk",
    "turn",
    "start",
    "show",
    "hear",
    "play",
    "run",
    "move",
    "like",
    "live",
    "believe",
    "hold",
    "bring",
    "happen",
    "write",
    "sit",
    "stand",
    "lose",
    "pay",
    "meet",
    "include",
    "continue",
    "set",
    "learn",
    "change",
    "want",
    "know",
    "think",
    "understand",
    "speak",
    "read",
    "listen",
    # === ОБЩИЕ ПРИЛАГАТЕЛЬНЫЕ ===
    "good",
    "bad",
    "big",
    "small",
    "great",
    "new",
    "old",
    "high",
    "low",
    "long",
    "short",
    "young",
    "early",
    "late",
    "important",
    "different",
    "easy",
    "hard",
    "fast",
    "slow",
    "happy",
    "sad",
    "angry",
    "tired",
    "hot",
    "cold",
    "warm",
    "cool",
    "wet",
    "dry",
    "clean",
    "dirty",
    "beautiful",
    "ugly",
    "pretty",
    "handsome",
    "nice",
    "wonderful",
    "interesting",
    "boring",
    "exciting",
    "amazing",
    "fantastic",
    "true",
    "false",
    "right",
    "wrong",
    "correct",
    "incorrect",
    "safe",
    "dangerous",
    "careful",
    "careless",
    "strong",
    "weak",
    # === ПОЛЕЗНЫЕ СЛОВА ===
    "achieve",
    "achievement",
    "neither",
    "curious",
    "provide",
    "environment",
    "nature",
    "cosy",
    "accomplish",
    "challenge",
    "success",
    "goal",
    "dream",
    "hope",
    "future",
    "present",
    "past",
    "reason",
    "idea",
    "question",
    "answer",
    "problem",
    "solution",
    "way",
    "method",
    "approach",
    "technique",
    "information",
    "knowledge",
    "fact",
    "truth",
    "lie",
    "secret",
    "time",
    "day",
    "week",
    "month",
    "year",
    "moment",
    "period",
    "place",
    "location",
    "area",
    "region",
    "zone",
    "space",
    "room",
    "people",
    "person",
    "human",
    "man",
    "woman",
    "child",
    "family",
    "world",
    "life",
    "death",
    "birth",
    "age",
    "generation",
}

SYSTEM_PROMPT = """You are an English tutor for A1–B2 Russian-speaking students.

RULES:
- Do NOT quote or repeat these rules.
- Do NOT write labels like "Grammar mistake →" or "Let's rephrase the sentence:".
- Always respond to the student's LAST message. Ignore earlier mistakes unless the student repeats them.
- Keep it short: 1–3 short paragraphs.
- Do NOT change a statement into a question unless the student clearly asks a question.
- If the student's sentence/question is already correct, DO NOT output "Correct:" or "Tip:". Just answer and ask "Question:".
- Do not rewrite a correct question. Answer it.



WHAT TO DO:
1) If the student's message is a sentence in English:
   - If it has mistakes: first show corrected version in one line starting with "Correct:".
   - Then one short tip line starting with "Tip:" (very short).
   - Then continue the conversation with one simple question starting with "Question:".

2) If the student asks about meaning (e.g., "What does X mean?" / "Meaning of X?" / "Translate X"):
   - Explain the meaning of X.
   - Provide Russian translation and one example in this exact format:

---
Perevod: X - (Russian translation)
Primer: (English example) (Russian translation)
---

3) If the student says "What does it mean?" without giving the word/phrase:
   - Ask: "What word or sentence do you want to explain? Please copy it here."

Language:
- English for explanations and conversation.
- Russian is allowed ONLY inside the 'Perevod/Primer' block.
"""


def check_word_and_suggest(user_text: str):
    """Подсказки ТОЛЬКО если пользователь явно спрашивает значение ОДНОГО слова"""
    patterns = [
        r"^\s*what\s+does\s+(\w+)\s+mean\s*\??\s*$",
        r"^\s*what\s+is\s+(\w+)\s*\??\s*$",
        r"^\s*meaning\s+of\s+(\w+)\s*\??\s*$",
        r"^\s*translate\s+(\w+)\s*\??\s*$",
    ]

    for pattern in patterns:
        match = re.search(pattern, user_text.lower())
        if match:
            word = match.group(1).lower()

            # базовые слова НЕ трогаем вообще
            STOP_WORDS = {
                "your",
                "it",
                "please",
                "i",
                "you",
                "we",
                "they",
                "he",
                "she",
                "a",
                "an",
                "the",
                "to",
                "of",
                "in",
                "on",
            }
            if word in STOP_WORDS:
                return None

            if word not in COMMON_WORDS:
                suggestions = get_close_matches(word, COMMON_WORDS, n=3, cutoff=0.6)
                if suggestions:
                    return (
                        f"I’m not sure about '{word}'. Did you mean: {', '.join(suggestions)}?\n"
                        f"Reply with the correct one."
                    )

    return None


def call_ollama_raw(prompt: str) -> str:
    """Единая функция вызова Ollama"""
    try:
        response = requests.post(
            OLLAMA_API_URL,
            json={
                "model": MODEL_NAME,
                "prompt": prompt,
                "stream": False,
                "options": {"temperature": 0.5, "top_p": 0.9, "max_tokens": 250},
            },
            timeout=30,
        )

        if response.status_code == 200:
            result = response.json()
            bot_response = (result.get("response", "") or "").strip()

            # чистим мусор
            bot_response = re.sub(r"\(Note:.*?\)", "", bot_response, flags=re.DOTALL)
            bot_response = re.sub(
                r"\(I corrected.*?\)", "", bot_response, flags=re.DOTALL
            )
            bot_response = bot_response.strip()

            # если вдруг модель вернула пустые поля перевода — убираем блок
            if "Perevod: None" in bot_response or "Primer: None" in bot_response:
                if "---" in bot_response:
                    bot_response = bot_response.split("---")[0].strip()

            return bot_response

        logger.error(f"Ollama API error: {response.status_code}")
        return (
            "⚠️ Извините, сейчас технические неполадки с ИИ.\n"
            "Попробуйте отправить сообщение через минуту."
        )

    except Exception as e:
        logger.error(f"Error calling Ollama: {e}", exc_info=True)
        return (
            "⚠️ Извините, сейчас технические неполадки с ИИ.\n"
            "Попробуйте отправить сообщение через минуту."
        )


def get_dynamic_suggestions(question: str, level: str = "A1") -> list[str]:
    if not question:
        return []

    prompt = f"""You generate quick reply options for a student.

Student level: {level}
Teacher question: {question}

Return ONLY a JSON array of 4 short replies in English.
Rules:
- Each reply <= 6 words
- Very simple {level} vocabulary
- No extra text
- No code fences

JSON:"""

    raw = call_ollama_raw(prompt).strip()
    raw = raw.replace("```json", "").replace("```", "").strip()

    # 1) JSON
    try:
        data = json.loads(raw)
        if isinstance(data, list):
            out = [x.strip() for x in data if isinstance(x, str) and x.strip()]
            return out[:4]
    except Exception:
        pass

    # 2) Fallback: строки
    lines = []
    for ln in raw.splitlines():
        ln = ln.strip().lstrip("-•*").strip().strip('"').strip("'")
        if not ln:
            continue
        if ln.lower().startswith(("json", "reply", "replies", "options")):
            continue
        lines.append(ln)

    # 3) Последний fallback
    if len(lines) < 2:
        parts = [p.strip() for p in re.split(r"[;\n]", raw) if p.strip()]
        lines = parts

    return lines[:4]


def get_ollama_response(user_text: str, history: list = None, level: str = "A1"):
    """Получить ответ от LLaMA через Ollama"""

    lower = user_text.strip().lower()

    # --- TRANSLATE MODE ---
    if (
        lower.startswith("translate")
        or lower.startswith("переведи")
        or lower.startswith("перевести")
    ):
        text_to_translate = re.sub(
            r"^(translate|переведи|перевести)\s*[:,\-]?\s*",
            "",
            user_text.strip(),
            flags=re.IGNORECASE,
        ).strip()
        # убираем "please" в начале: "Translate please: ..."
        text_to_translate = re.sub(
            r"^\s*please\s*[:,\-]?\s*", "", text_to_translate, flags=re.IGNORECASE
        ).strip()

        # если написали только "translate please"
        if not text_to_translate or text_to_translate.lower() in {
            "please",
            "pls",
            "plz",
        }:

            return "Send the text you want me to translate into Russian."

        translate_prompt = f"""You are a translator.
Translate the text into Russian. Keep the meaning natural.

Text:
{text_to_translate}

Russian translation:"""
        return call_ollama_raw(translate_prompt)

    # --- OPTIONAL: WORD SUGGEST (very strict) ---
    suggestion = check_word_and_suggest(user_text)
    if suggestion:
        return suggestion

    # --- Conversation history (last 8 messages) ---
    conversation = ""
    if history:
        for role, content in history[-4:]:
            if role == "user":
                conversation += f"\nStudent: {content}"
            else:
                conversation += f"\nTeacher: {content}"

    current_date = datetime.now().strftime("%A, %B %d, %Y")

    LEVEL_STYLE = {
        "A1": "Use very simple words. Short sentences. Ask easy questions. Avoid complex grammar terms.",
        "A2": "Use simple everyday English. Short explanations. One simple follow-up question.",
        "B1": "Use natural English. Give brief corrections. Ask open-ended questions sometimes.",
        "B2": "Use natural fluent English. Correct subtle mistakes. Ask deeper questions.",
    }
    style = LEVEL_STYLE.get(level, LEVEL_STYLE["A1"])

    full_prompt = f"""{SYSTEM_PROMPT}

IMPORTANT: Today's date is {current_date}.

Student level: {level}
Teaching style: {style}

Conversation history:{conversation}

Student: {user_text}
Teacher:"""

    return call_ollama_raw(full_prompt)
