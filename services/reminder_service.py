"""
–§–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π —á–∞—Å, –∫—Ç–æ –Ω–µ –∑–∞—Ö–æ–¥–∏–ª –±–æ–ª—å—à–µ —Å—É—Ç–æ–∫,
–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—ë–ø–ª–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (1 —Ä–∞–∑ –≤ –¥–µ–Ω—å).
"""
import asyncio
import logging
import random

from aiogram import Bot

from database import get_inactive_users, set_reminder_sent, get_user

logger = logging.getLogger(__name__)

# –®–∞–±–ª–æ–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ‚Äî –±–æ—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π
REMINDER_TEMPLATES = [
    (
        "üëã –ü—Ä–∏–≤–µ—Ç! –î–∞–≤–Ω–æ –Ω–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞–ª—Å—è ‚Äî —Ç–≤–æ–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Å–∫—É—á–∞–µ—Ç!\n\n"
        "–î–∞–∂–µ 2-3 —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –¥–µ–Ω—å ‚Äî —É–∂–µ –ø—Ä–æ–≥—Ä–µ—Å—Å.\n"
        "–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –∏ —è –ø–æ–º–æ–≥—É! üéì"
    ),
    (
        "üî• –≠–π, —Ç–≤–æ–π streak —Å–∫–æ—Ä–æ —Å–≥–æ—Ä–∏—Ç!\n\n"
        "–ó–∞–π–¥–∏ –∏ –Ω–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚Äî\n"
        "—Å–æ—Ö—Ä–∞–Ω–∏ —Å–≤–æ—é —Å–µ—Ä–∏—é –∏ –∑–∞—Ä–∞–±–æ—Ç–∞–π –±–æ–Ω—É—Å! üí™"
    ),
    (
        "üéØ Quick challenge: –æ–ø–∏—à–∏ —Å–≤–æ–π –¥–µ–Ω—å –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º!\n\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: \"Today I woke up late and had coffee.\"\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π ‚Äî —è –ø—Ä–æ–≤–µ—Ä—é –∏ –ø–æ–º–æ–≥—É! ‚ú®"
    ),
    (
        "üí° –ó–Ω–∞–µ—à—å —Å–ª–æ–≤–æ –¥–Ω—è?\n\n"
        "<b>Procrastinate</b> ‚Äî –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –¥–µ–ª–∞ –Ω–∞ –ø–æ—Ç–æ–º üòÖ\n\n"
        "\"I should practice English, but I keep procrastinating.\"\n\n"
        "–ù–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π ‚Äî –Ω–∞–ø–∏—à–∏ –º–Ω–µ! üöÄ"
    ),
    (
        "üìö –ú–∞–ª–µ–Ω—å–∫–∏–π —Ñ–∞–∫—Ç: –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∞–∫—Ç–∏–∫—É—é—Ç\n"
        "–∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–æ 5 –º–∏–Ω—É—Ç, –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä—É—é—Ç\n"
        "–±—ã—Å—Ç—Ä–µ–µ —Ç–µ—Ö, –∫—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –ø–æ —á–∞—Å—É.\n\n"
        "–î–∞–≤–∞–π 5 –º–∏–Ω—É—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? üé§"
    ),
]


async def send_reminders(bot: Bot):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º."""
    inactive = get_inactive_users(inactive_hours=24)

    if not inactive:
        return 0

    sent = 0
    for user_id, username, streak, last_active in inactive:
        template = random.choice(REMINDER_TEMPLATES)

        # –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å streak
        if streak and streak > 0:
            template = (
                f"üî• –£ —Ç–µ–±—è –±—ã–ª streak <b>{streak} –¥–Ω–µ–π</b> –ø–æ–¥—Ä—è–¥!\n"
                "–ù–µ –¥–∞–π –µ–º—É —Å–≥–æ—Ä–µ—Ç—å ‚Äî –∑–∞–π–¥–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Å—è —Å–µ–≥–æ–¥–Ω—è!\n\n"
                "–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –∏ —è –ø–æ–º–æ–≥—É! üí™"
            )

        try:
            await bot.send_message(user_id, template, parse_mode="HTML")
            set_reminder_sent(user_id)
            sent += 1
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å API
            await asyncio.sleep(0.5)
        except Exception as e:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ –∏–ª–∏ —É–¥–∞–ª–∏–ª –∞–∫–∫–∞—É–Ω—Ç
            logger.debug(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ {user_id}: {e}")

    if sent > 0:
        logger.info(f"üì¨ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º")

    return sent


async def reminder_loop(bot: Bot):
    """–§–æ–Ω–æ–≤—ã–π —Ü–∏–∫–ª ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π —á–∞—Å."""
    logger.info("‚è∞ –°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å)")
    while True:
        try:
            await send_reminders(bot)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ reminder_loop: {e}")
        await asyncio.sleep(3600)  # 1 —á–∞—Å
